#!/bin/sh

# Args: $1=prev HEAD, $2=new HEAD, $3=branch flag (1=branch checkout, 0=file checkout)
PREV_HEAD=$1
NEW_HEAD=$2
IS_BRANCH_CHECKOUT=$3

# Only run on branch checkouts, not file checkouts
if [ "$IS_BRANCH_CHECKOUT" = "0" ]; then
	exit 0
fi

# Skip on initial worktree creation (PREV_HEAD is null ref)
if [ "$PREV_HEAD" = "0000000000000000000000000000000000000000" ]; then
	exit 0
fi

# Auto-install dependencies if package.json or bun.lock changed
CHANGED_FILES=$(git diff --name-only "$PREV_HEAD" "$NEW_HEAD" 2>/dev/null)

if echo "$CHANGED_FILES" | grep -qE "(package\.json|bun\.lock)"; then
	echo "ğŸ“¦ Dependencies changed, running bun install..."
	bun install
	echo "ğŸ“± Syncing Capacitor..."
	(cd apps/web && bunx cap sync) || echo "âš ï¸ cap sync skipped (worktree or missing deps)"
fi
